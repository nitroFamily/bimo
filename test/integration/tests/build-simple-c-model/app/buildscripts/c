#!/usr/bin/env stack
-- stack --install-ghc runghc --package shelly

{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE ExtendedDefaultRules #-}
{-# OPTIONS_GHC -fno-warn-type-defaults #-}
import Prelude hiding (FilePath)
import Shelly
import qualified Data.Text as T
import Options.Applicative
default (T.Text)

data Args = Args ![T.Text] !T.Text ![T.Text]

parser :: Parser Args
parser = Args
    <$> option (str >>= parseSep) (long "src"
       <> short 's'
       <> metavar "SRC FILES"
       <> help "Source files")
    <*> option (str >>= parseText) (long "dst"
       <> short 'd'
       <> metavar "DST FILE"
       <> help "dest file")
    <*> option (str >>= parseSep) (long "libs"
       <> short 'l'
       <> metavar "LIBS"
       <> help "Using libs")
  where
    parseSep str = return $ T.splitOn ":" $ T.pack str
    parseText str = return $ T.pack str


main = shelly $ verbosely $ do
    (Args src dst libs) <- liftIO $ execParser $ info parser idm
    run_ "gcc" [ head src
               , "-o"
               , dst
               ]
